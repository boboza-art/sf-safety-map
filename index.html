
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="utf-8">
            <title>Guardian Sentinel v4.0</title>
            <style>
                body, html { margin: 0; padding: 0; height: 100%; font-family: 'Inter', -apple-system, sans-serif; background: #fff; overflow: hidden; }
                .container { display: flex; height: 100vh; }
                #map-box { flex: 2; height: 100%; background: #f8f9fa; }
                #side-panel { flex: 1; height: 100%; background: #fff; padding: 35px; border-left: 1px solid #eee; display: flex; flex-direction: column; overflow-y: auto; box-shadow: -5px 0 20px rgba(0,0,0,0.02); }
                
                h1 { font-size: 24px; font-weight: 800; margin: 0; letter-spacing: -1px; }
                .section-title { font-size: 11px; font-weight: 700; color: #a0aec0; text-transform: uppercase; letter-spacing: 1.2px; margin: 25px 0 10px 0; }
                
                .search-box { background: #f7fafc; border-radius: 12px; padding: 12px; border: 1px solid #edf2f7; display: flex; }
                input { background: transparent; border: none; width: 100%; font-size: 15px; outline: none; }
                
                /* 时序滑块样式 */
                .slider-container { background: #f7fafc; padding: 20px; border-radius: 12px; border: 1px solid #edf2f7; margin-bottom: 20px; }
                #time-slider { width: 100%; cursor: pointer; }
                .slider-label { display: flex; justify-content: space-between; font-size: 11px; color: #718096; margin-top: 8px; }

                .legend-card { background: #fff; border-radius: 12px; padding: 15px; border: 1px solid #edf2f7; margin-bottom: 15px; font-size: 12px; line-height: 1.5; }
                .bar { height: 6px; border-radius: 3px; margin: 8px 0; width: 100%; }
                
                .footer { margin-top: auto; font-size: 10px; color: #cbd5e0; padding-top: 20px; border-top: 1px solid #f1f5f9; }
                .meta-val { color: #4a5568; font-weight: 600; }
            </style>
            <script>
                var rawData = [];
                var heatLayer;
                var currentMap;
                
                // 核心修复：捕获 Leaflet 实例
                (function() {
                    if (window.L) {
                        L.Map.addInitHook(function() {
                            window.currentMap = this;
                            console.log("Map instance captured.");
                        });
                    }
                })();
            </script>
        </head>
        <body>
            <div class="container">
                <div id="map-box"><div style="width:100%;"><div style="position:relative;width:100%;height:0;padding-bottom:60%;"><span style="color:#565656">Make this Notebook Trusted to load map: File -> Trust Notebook</span><iframe srcdoc="&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
    
    &lt;meta http-equiv=&quot;content-type&quot; content=&quot;text/html; charset=UTF-8&quot; /&gt;
    &lt;script src=&quot;https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.js&quot;&gt;&lt;/script&gt;
    &lt;script src=&quot;https://code.jquery.com/jquery-3.7.1.min.js&quot;&gt;&lt;/script&gt;
    &lt;script src=&quot;https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js&quot;&gt;&lt;/script&gt;
    &lt;script src=&quot;https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.js&quot;&gt;&lt;/script&gt;
    &lt;link rel=&quot;stylesheet&quot; href=&quot;https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.css&quot;/&gt;
    &lt;link rel=&quot;stylesheet&quot; href=&quot;https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css&quot;/&gt;
    &lt;link rel=&quot;stylesheet&quot; href=&quot;https://netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap-glyphicons.css&quot;/&gt;
    &lt;link rel=&quot;stylesheet&quot; href=&quot;https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.2.0/css/all.min.css&quot;/&gt;
    &lt;link rel=&quot;stylesheet&quot; href=&quot;https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.css&quot;/&gt;
    &lt;link rel=&quot;stylesheet&quot; href=&quot;https://cdn.jsdelivr.net/gh/python-visualization/folium/folium/templates/leaflet.awesome.rotate.min.css&quot;/&gt;
    
            &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width,
                initial-scale=1.0, maximum-scale=1.0, user-scalable=no&quot; /&gt;
            &lt;style&gt;
                #map_8891b5f3c8562414f0d7c959a5768a94 {
                    position: relative;
                    width: 100.0%;
                    height: 100.0%;
                    left: 0.0%;
                    top: 0.0%;
                }
                .leaflet-container { font-size: 1rem; }
            &lt;/style&gt;

            &lt;style&gt;html, body {
                width: 100%;
                height: 100%;
                margin: 0;
                padding: 0;
            }
            &lt;/style&gt;

            &lt;style&gt;#map {
                position:absolute;
                top:0;
                bottom:0;
                right:0;
                left:0;
                }
            &lt;/style&gt;

            &lt;script&gt;
                L_NO_TOUCH = false;
                L_DISABLE_3D = false;
            &lt;/script&gt;

        
&lt;/head&gt;
&lt;body&gt;
    
    
            &lt;div class=&quot;folium-map&quot; id=&quot;map_8891b5f3c8562414f0d7c959a5768a94&quot; &gt;&lt;/div&gt;
        
&lt;/body&gt;
&lt;script&gt;
    
    
            var map_8891b5f3c8562414f0d7c959a5768a94 = L.map(
                &quot;map_8891b5f3c8562414f0d7c959a5768a94&quot;,
                {
                    center: [37.7749, -122.4194],
                    crs: L.CRS.EPSG3857,
                    ...{
  &quot;zoom&quot;: 13,
  &quot;zoomControl&quot;: false,
  &quot;preferCanvas&quot;: false,
}

                }
            );

            

        
    
            var tile_layer_b0676ca00e756bf5cf347a4232750c8a = L.tileLayer(
                &quot;https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png&quot;,
                {
  &quot;minZoom&quot;: 0,
  &quot;maxZoom&quot;: 20,
  &quot;maxNativeZoom&quot;: 20,
  &quot;noWrap&quot;: false,
  &quot;attribution&quot;: &quot;\u0026copy; \u003ca href=\&quot;https://www.openstreetmap.org/copyright\&quot;\u003eOpenStreetMap\u003c/a\u003e contributors \u0026copy; \u003ca href=\&quot;https://carto.com/attributions\&quot;\u003eCARTO\u003c/a\u003e&quot;,
  &quot;subdomains&quot;: &quot;abcd&quot;,
  &quot;detectRetina&quot;: false,
  &quot;tms&quot;: false,
  &quot;opacity&quot;: 1,
}

            );
        
    
            tile_layer_b0676ca00e756bf5cf347a4232750c8a.addTo(map_8891b5f3c8562414f0d7c959a5768a94);
        
    
            var marker_a864b39c1fd0c4d5e4fc27680f43a26f = L.marker(
                [37.783, -122.417],
                {
}
            ).addTo(map_8891b5f3c8562414f0d7c959a5768a94);
        
    
            var div_icon_c1936f28e4b4ca23b7fea733a351374b = L.divIcon({
  &quot;html&quot;: &quot;\u003cdiv style=\&quot;font-family: sans-serif; color: rgba(255,0,0,0.7); font-weight: bold; font-size: 12px; width: 120px;\&quot;\u003eTenderloin (\u6781\u9ad8\u5371)\u003c/div\u003e&quot;,
  &quot;className&quot;: &quot;empty&quot;,
});
        
    
                marker_a864b39c1fd0c4d5e4fc27680f43a26f.setIcon(div_icon_c1936f28e4b4ca23b7fea733a351374b);
            
    
            var marker_07ff924a3cb496b13f6126f5ce2c2166 = L.marker(
                [37.76, -122.415],
                {
}
            ).addTo(map_8891b5f3c8562414f0d7c959a5768a94);
        
    
            var div_icon_0cafa5eda8170f5279058216d4b42674 = L.divIcon({
  &quot;html&quot;: &quot;\u003cdiv style=\&quot;font-family: sans-serif; color: rgba(255,0,0,0.7); font-weight: bold; font-size: 12px; width: 120px;\&quot;\u003eMission District\u003c/div\u003e&quot;,
  &quot;className&quot;: &quot;empty&quot;,
});
        
    
                marker_07ff924a3cb496b13f6126f5ce2c2166.setIcon(div_icon_0cafa5eda8170f5279058216d4b42674);
            
    
            var marker_1ea614cc50f6460dac625ba350998e5a = L.marker(
                [37.778, -122.405],
                {
}
            ).addTo(map_8891b5f3c8562414f0d7c959a5768a94);
        
    
            var div_icon_3a8bade93d1e18bbb7e6cdaf2889c934 = L.divIcon({
  &quot;html&quot;: &quot;\u003cdiv style=\&quot;font-family: sans-serif; color: rgba(255,0,0,0.7); font-weight: bold; font-size: 12px; width: 120px;\&quot;\u003eSoMa / 6th St\u003c/div\u003e&quot;,
  &quot;className&quot;: &quot;empty&quot;,
});
        
    
                marker_1ea614cc50f6460dac625ba350998e5a.setIcon(div_icon_3a8bade93d1e18bbb7e6cdaf2889c934);
            
&lt;/script&gt;
&lt;/html&gt;" style="position:absolute;width:100%;height:100%;left:0;top:0;border:none !important;" allowfullscreen webkitallowfullscreen mozallowfullscreen></iframe></div></div></div>
                <div id="side-panel">
                    <h1>Guardian Sentinel</h1>
                    <div class="section-title">万能城市跳转</div>
                    <div class="search-box">
                        <input type="text" id="city-search" placeholder="输入城市 (如 Paris, London) 并回车...">
                    </div>

                    <div class="section-title">时序动态回顾 (过去1年)</div>
                    <div class="slider-container">
                        <input type="range" id="time-slider" min="0" max="365" value="0">
                        <div class="slider-label">
                            <span>现在</span>
                            <span id="slider-desc">显示全部数据</span>
                            <span>1年前</span>
                        </div>
                    </div>

                    <div class="section-title">安全风险注释</div>
                    <div class="legend-card">
                        <span style="font-weight:700;">● 区域案发密度</span>
                        <div class="bar" style="background: linear-gradient(to right, #48bb78, #ecc94b, #f56565);"></div>
                        <p style="color:#718096; margin:0;">基于 1km Gaussian 扩散加权。红色文字标记为地图上历史极高危聚集点。</p>
                    </div>

                    <div class="footer">
                        <div>版本：<span class="meta-val">v4.0.1 Sentinel Elite</span></div>
                        <div>更新时间：<span class="meta-val">2026-02-10 13:13</span></div>
                    </div>
                </div>
            </div>
            <script>
                // 1. 实现城市跳转 (Geocoder Fix)
                document.getElementById('city-search').addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        fetch('https://nominatim.openstreetmap.org/search?format=json&q=' + encodeURIComponent(this.value))
                            .then(res => res.json())
                            .then(data => {
                                if (data && data.length > 0 && window.currentMap) {
                                    window.currentMap.flyTo([parseFloat(data[0].lat), parseFloat(data[0].lon)], 13);
                                }
                            });
                    }
                });

                // 2. 实现时序滑块逻辑
                const slider = document.getElementById('time-slider');
                const desc = document.getElementById('slider-desc');
                
                slider.addEventListener('input', function() {
                    const daysLimit = parseInt(this.value);
                    desc.innerText = daysLimit === 0 ? "显示全部数据" : "仅显示 " + daysLimit + " 天前至今";
                    
                    // 过滤数据
                    const filtered = rawData.filter(p => p[3] <= daysLimit || daysLimit === 0);
                    
                    // 捕获热力图层并更新 (Folium 通常会生成 HeatMap 层)
                    if (!heatLayer) {
                        // 第一次寻找热力层
                        window.currentMap.eachLayer(l => {
                            if (l._latlngs && !l._popup) heatLayer = l;
                        });
                    }
                    if (heatLayer) heatLayer.setLatLngs(filtered);
                });
                
                // 解决白框缝隙的最后一道防线
                setInterval(() => {
                    document.querySelectorAll('.leaflet-container').forEach(c => c.style.background = '#f8f9fa');
                }, 1000);
            </script>
        </body>
        </html>
        